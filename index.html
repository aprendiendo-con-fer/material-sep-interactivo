<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduEstrellas - Aprende y Gana</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Nunito', sans-serif; }
    
    .neon-glow {
      text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
    }
    
    .neon-box {
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.5), 0 0 30px rgba(139, 92, 246, 0.3), inset 0 0 20px rgba(139, 92, 246, 0.1);
    }
    
    .neon-pink {
      box-shadow: 0 0 15px rgba(236, 72, 153, 0.5), 0 0 30px rgba(236, 72, 153, 0.3);
    }
    
    .neon-green {
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.5), 0 0 30px rgba(34, 197, 94, 0.3);
    }
    
    .neon-yellow {
      box-shadow: 0 0 15px rgba(250, 204, 21, 0.5), 0 0 30px rgba(250, 204, 21, 0.3);
    }
    
    .neon-cyan {
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.5), 0 0 30px rgba(6, 182, 212, 0.3);
    }
    
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes pulseGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .bounce-in {
      animation: bounceIn 0.6s ease-out;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .star-spin {
      animation: starSpin 1s ease-out;
    }
    
    @keyframes starSpin {
      0% { transform: rotate(0deg) scale(0); }
      50% { transform: rotate(180deg) scale(1.5); }
      100% { transform: rotate(360deg) scale(1); }
    }
    
    .confetti {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #8b5cf6, #ec4899, #06b6d4);
      background-size: 200% 100%;
      animation: gradientMove 2s linear infinite;
    }
    
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .game-card:hover {
      transform: translateY(-5px) scale(1.02);
    }
    
    .game-card {
      transition: all 0.3s ease;
    }
    
    .streak-fire {
      animation: fireFlicker 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes fireFlicker {
      0% { transform: scale(1) rotate(-5deg); }
      100% { transform: scale(1.1) rotate(5deg); }
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
    }
    
    .timer-urgent {
      animation: urgentPulse 0.5s ease-in-out infinite;
    }
    
    @keyframes urgentPulse {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #fbbf24; transform: scale(1.1); }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 overflow-auto">
  <div id="app" class="h-full w-full">
   <!-- Login Screen -->
   <div id="loginScreen" class="h-full w-full flex flex-col items-center justify-center p-4">
    <div class="text-center mb-8">
     <div class="text-6xl mb-4 floating">
      â­
     </div>
     <h1 id="appTitle" class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-pink-500 to-cyan-400 neon-glow mb-2">Material SEP Interactivo</h1>
     <p id="welcomeMsg" class="text-xl text-purple-300 font-semibold">Â¡Aprende y gana estrellas!</p>
    </div>
    <div class="bg-slate-800/80 rounded-3xl p-8 neon-box w-full max-w-md">
     <div class="space-y-4">
      <div>
       <label class="block text-pink-300 font-bold mb-2 text-lg">ğŸ‘¤ Usuario</label> <input type="text" id="loginUsername" placeholder="Tu nombre de usuario" class="w-full px-4 py-3 rounded-2xl bg-slate-700 text-white border-2 border-purple-500 text-lg font-semibold">
      </div>
      <div>
       <label class="block text-cyan-300 font-bold mb-2 text-lg">ğŸ”’ ContraseÃ±a</label> <input type="password" id="loginPassword" placeholder="Tu contraseÃ±a secreta" class="w-full px-4 py-3 rounded-2xl bg-slate-700 text-white border-2 border-purple-500 text-lg font-semibold">
      </div>
      <p id="loginError" class="text-red-400 text-center font-semibold hidden"></p><button onclick="handleLogin()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-purple-600 rounded-2xl text-white font-black text-xl neon-pink hover:scale-105 transition-transform"> ğŸš€ Â¡ENTRAR! </button> <button onclick="showRegister()" class="w-full py-3 bg-gradient-to-r from-cyan-500 to-green-500 rounded-2xl text-white font-bold text-lg neon-green hover:scale-105 transition-transform"> âœ¨ Crear cuenta nueva </button>
     </div>
    </div>
    <div class="mt-8 text-center">
     <p class="text-purple-400 text-sm">Creado por la Maestra</p>
     <p class="text-pink-400 font-bold">MarÃ­a Fernanda Flores Valenzuela</p><button onclick="showTerms()" class="text-cyan-400 text-sm underline mt-2 hover:text-cyan-300"> TÃ©rminos y Condiciones </button>
    </div>
   </div><!-- Register Screen -->
   <div id="registerScreen" class="h-full w-full hidden flex-col items-center justify-center p-4">
    <div class="text-center mb-6">
     <div class="text-5xl mb-3 floating">
      ğŸŒŸ
     </div>
     <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-cyan-400">Â¡Crea tu cuenta!</h2>
    </div>
    <div class="bg-slate-800/80 rounded-3xl p-6 neon-box w-full max-w-md">
     <div class="space-y-4">
      <div>
       <label class="block text-green-300 font-bold mb-2">ğŸ‘¤ Elige tu usuario</label> <input type="text" id="regUsername" placeholder="Ejemplo: estrella123" class="w-full px-4 py-3 rounded-2xl bg-slate-700 text-white border-2 border-green-500 font-semibold">
      </div>
      <div>
       <label class="block text-cyan-300 font-bold mb-2">ğŸ”’ Crea tu contraseÃ±a</label> <input type="password" id="regPassword" placeholder="MÃ­nimo 4 caracteres" class="w-full px-4 py-3 rounded-2xl bg-slate-700 text-white border-2 border-cyan-500 font-semibold">
      </div>
      <div>
       <label class="block text-purple-300 font-bold mb-2">ğŸ“š Selecciona tu grado</label> <select id="regGrade" class="w-full px-4 py-3 rounded-2xl bg-slate-700 text-white border-2 border-purple-500 font-semibold"> <option value="">-- Elige tu grado --</option> <option value="1ro">1er grado ğŸŒ±</option> <option value="2do">2do grado ğŸ“š</option> <option value="3ro">3er grado âœï¸</option> <option value="4to">4to grado ğŸ“–</option> <option value="5to">5to grado ğŸ“</option> <option value="6to">6to grado â­</option> </select>
      </div>
      <p id="regError" class="text-red-400 text-center font-semibold hidden"></p><button onclick="handleRegister()" class="w-full py-4 bg-gradient-to-r from-green-500 to-cyan-500 rounded-2xl text-white font-black text-xl neon-green hover:scale-105 transition-transform"> âœ… Â¡CREAR CUENTA! </button> <button onclick="showLogin()" class="w-full py-3 bg-slate-600 rounded-2xl text-white font-bold hover:bg-slate-500 transition-colors"> â† Volver al inicio </button>
     </div>
    </div>
   </div><!-- Main Dashboard -->
   <div id="mainDashboard" class="h-full w-full hidden flex-col overflow-auto">
    <!-- Top Bar -->
    <div class="bg-slate-800/90 p-3 flex flex-wrap items-center justify-between gap-2 sticky top-0 z-50">
     <div class="flex items-center gap-2">
      <span class="text-2xl">ğŸ‘‹</span> <span id="playerName" class="text-white font-bold text-lg"></span> <span id="playerGrade" class="text-purple-300 font-semibold text-sm ml-2"></span>
     </div>
     <div class="flex flex-wrap gap-2">
      <div class="bg-yellow-500/20 px-3 py-1 rounded-full flex items-center gap-1 neon-yellow">
       <span class="text-xl">â­</span> <span id="starsDisplay" class="text-yellow-300 font-black">0</span>
      </div>
      <div class="bg-amber-500/20 px-3 py-1 rounded-full flex items-center gap-1">
       <span class="text-xl">ğŸª™</span> <span id="coinsDisplay" class="text-amber-300 font-black">0</span>
      </div>
      <div class="bg-purple-500/20 px-3 py-1 rounded-full flex items-center gap-1">
       <span class="text-xl">ğŸ”‘</span> <span id="keysDisplay" class="text-purple-300 font-black">0</span>
      </div>
      <div class="bg-red-500/20 px-3 py-1 rounded-full flex items-center gap-1">
       <span class="text-xl">â¤ï¸</span> <span id="livesDisplay" class="text-red-300 font-black">5</span>
      </div>
     </div><button onclick="handleLogout()" class="bg-slate-600 px-3 py-1 rounded-full text-white text-sm hover:bg-slate-500"> Salir </button>
    </div><!-- Level & XP Bar -->
    <div class="bg-slate-800/50 px-4 py-2">
     <div class="flex items-center gap-3">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 w-12 h-12 rounded-full flex items-center justify-center neon-pink">
       <span id="levelDisplay" class="text-white font-black text-xl">1</span>
      </div>
      <div class="flex-1">
       <div class="flex justify-between text-sm mb-1">
        <span class="text-purple-300 font-semibold">Nivel <span id="levelText">1</span></span> <span class="text-pink-300 font-semibold"><span id="xpCurrent">0</span>/<span id="xpNeeded">100</span> XP</span>
       </div>
       <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
        <div id="xpBar" class="h-full progress-bar rounded-full" style="width: 0%"></div>
       </div>
      </div>
     </div>
    </div><!-- Daily Streak -->
    <div class="mx-4 mt-3 bg-gradient-to-r from-orange-600/30 to-red-600/30 rounded-2xl p-4 border-2 border-orange-500">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
       <span class="text-3xl streak-fire">ğŸ”¥</span>
       <div>
        <p class="text-orange-300 font-bold text-lg">Racha diaria</p>
        <p class="text-white font-black text-2xl"><span id="streakDisplay">0</span> dÃ­as</p>
       </div>
      </div>
      <div class="flex gap-1">
       <div id="streakDots" class="flex gap-1"></div>
      </div>
     </div>
     <p id="day7Reward" class="text-yellow-300 text-sm mt-2 hidden">ğŸ Â¡DÃ­a 7 = MEGA RECOMPENSA!</p>
    </div><!-- Daily Tasks -->
    <div class="mx-4 mt-4 bg-slate-800/70 rounded-2xl p-4 neon-box">
     <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-green-400">ğŸ“‹ Misiones del DÃ­a</h3>
      <div class="text-sm bg-green-500/20 px-3 py-1 rounded-full">
       <span id="tasksCompleted">0</span>/5
      </div>
     </div>
     <div id="dailyTasksList" class="space-y-2"></div>
     <div id="allTasksBonus" class="hidden mt-3 bg-gradient-to-r from-yellow-500/30 to-orange-500/30 rounded-xl p-3 text-center bounce-in">
      <p class="text-yellow-300 font-bold">ğŸ‰ Â¡TODAS COMPLETADAS!</p>
      <p class="text-white font-black text-lg">+50 â­ +20 ğŸª™ BONUS</p>
     </div>
    </div><!-- Weekly Challenges -->
    <div class="mx-4 mt-4 bg-slate-800/70 rounded-2xl p-4 neon-pink">
     <h3 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400 mb-3">ğŸ† Retos Semanales</h3>
     <div id="weeklyTasksList" class="space-y-2"></div>
    </div><!-- Games Section -->
    <div class="mx-4 mt-4 mb-4">
     <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-400 mb-4 text-center">ğŸ® Â¡ELIGE TU JUEGO!</h3>
     <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="gamesGrid"></div>
    </div><!-- Shop Button -->
    <div class="mx-4 mb-4">
     <button onclick="showShop()" class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl text-white font-black text-xl neon-yellow hover:scale-105 transition-transform"> ğŸ›’ TIENDA - Compra vidas y mÃ¡s </button>
    </div>
   </div><!-- Game Screen -->
   <div id="gameScreen" class="h-full w-full hidden flex-col overflow-auto">
    <div class="bg-slate-800/90 p-3 flex items-center justify-between sticky top-0 z-50">
     <button onclick="exitGame()" class="bg-red-500 px-4 py-2 rounded-xl text-white font-bold hover:bg-red-600"> â† Salir </button>
     <div id="gameTimer" class="text-2xl font-black text-cyan-400">
      â±ï¸ 60
     </div>
     <div class="flex gap-2">
      <span class="text-xl">â¤ï¸</span> <span id="gameLives" class="text-red-300 font-black">5</span>
     </div>
    </div>
    <div class="flex-1 p-4">
     <div id="gameTitle" class="text-2xl font-black text-center text-white mb-4"></div>
     <div id="gameContent" class="bg-slate-800/70 rounded-2xl p-6 neon-box"></div>
    </div>
    <div class="bg-slate-800/90 p-4">
     <div class="flex justify-between items-center">
      <span class="text-green-400 font-bold">âœ… Correctas: <span id="correctCount">0</span></span> <span class="text-red-400 font-bold">âŒ Errores: <span id="wrongCount">0</span></span>
     </div>
    </div>
   </div><!-- Shop Modal -->
   <div id="shopModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-3xl p-6 max-w-md w-full neon-box max-h-[90%] overflow-auto">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-400">ğŸ›’ TIENDA</h2><button onclick="closeShop()" class="text-3xl text-white hover:text-red-400">Ã—</button>
     </div>
     <div class="mb-4 p-3 bg-slate-700/50 rounded-xl">
      <p class="text-amber-300 font-bold">Tus monedas: ğŸª™ <span id="shopCoins">0</span></p>
     </div>
     <div class="space-y-3">
      <div class="bg-gradient-to-r from-red-600/30 to-pink-600/30 rounded-xl p-4 flex items-center justify-between">
       <div>
        <p class="text-white font-bold text-lg">â¤ï¸ +1 Vida</p>
        <p class="text-red-300 text-sm">Recupera una vida</p>
       </div><button onclick="buyItem('life', 10)" class="bg-red-500 px-4 py-2 rounded-xl text-white font-bold hover:bg-red-600"> ğŸª™ 10 </button>
      </div>
      <div class="bg-gradient-to-r from-purple-600/30 to-blue-600/30 rounded-xl p-4 flex items-center justify-between">
       <div>
        <p class="text-white font-bold text-lg">ğŸ”‘ +1 Llave</p>
        <p class="text-purple-300 text-sm">Desbloquea juegos</p>
       </div><button onclick="buyItem('key', 25)" class="bg-purple-500 px-4 py-2 rounded-xl text-white font-bold hover:bg-purple-600"> ğŸª™ 25 </button>
      </div>
      <div class="bg-gradient-to-r from-cyan-600/30 to-green-600/30 rounded-xl p-4 flex items-center justify-between">
       <div>
        <p class="text-white font-bold text-lg">âš¡ +50 XP</p>
        <p class="text-cyan-300 text-sm">Sube de nivel</p>
       </div><button onclick="buyItem('xp', 30)" class="bg-cyan-500 px-4 py-2 rounded-xl text-white font-bold hover:bg-cyan-600"> ğŸª™ 30 </button>
      </div>
      <div class="bg-gradient-to-r from-yellow-600/30 to-amber-600/30 rounded-xl p-4 flex items-center justify-between">
       <div>
        <p class="text-white font-bold text-lg">â­ +10 Estrellas</p>
        <p class="text-yellow-300 text-sm">Cambia por premios</p>
       </div><button onclick="buyItem('stars', 50)" class="bg-yellow-500 px-4 py-2 rounded-xl text-white font-bold hover:bg-yellow-600"> ğŸª™ 50 </button>
      </div>
     </div>
    </div>
   </div><!-- Reward Modal -->
   <div id="rewardModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-purple-800 to-pink-800 rounded-3xl p-8 max-w-sm w-full text-center neon-pink bounce-in">
     <div id="rewardIcon" class="text-7xl mb-4 star-spin">
      ğŸ‰
     </div>
     <h2 id="rewardTitle" class="text-3xl font-black text-white mb-2">Â¡FELICIDADES!</h2>
     <p id="rewardText" class="text-xl text-pink-200 mb-6"></p><button onclick="closeReward()" class="bg-gradient-to-r from-yellow-400 to-orange-500 px-8 py-3 rounded-2xl text-white font-black text-xl hover:scale-105 transition-transform"> Â¡GENIAL! </button>
    </div>
   </div><!-- Terms Modal -->
   <div id="termsModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-4 overflow-auto">
    <div class="bg-slate-800 rounded-3xl p-6 max-w-2xl w-full neon-box max-h-[90%] overflow-auto">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">ğŸ“œ TÃ©rminos y Condiciones</h2><button onclick="closeTerms()" class="text-3xl text-white hover:text-red-400">Ã—</button>
     </div>
     <div class="text-purple-200 space-y-4 text-sm">
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">1. Propiedad Intelectual</h3>
       <p>EduEstrellas es una creaciÃ³n original de la Maestra MarÃ­a Fernanda Flores Valenzuela. Todos los derechos de autor y propiedad intelectual estÃ¡n reservados.</p>
      </section>
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">2. Licencia de Uso</h3>
       <p>Este software educativo es de uso exclusivo para maestros/docentes que hayan adquirido la licencia correspondiente mediante compra autorizada. La licencia es personal e intransferible.</p>
      </section>
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">3. Uso Permitido</h3>
       <ul class="list-disc list-inside space-y-1">
        <li>Los maestros licenciados pueden usar esta herramienta con sus propios alumnos.</li>
        <li>Se permite el uso en el aula y para tareas escolares.</li>
        <li>El contenido es apropiado para estudiantes de 3Â° y 4Â° grado de primaria.</li>
       </ul>
      </section>
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">4. Restricciones</h3>
       <ul class="list-disc list-inside space-y-1">
        <li>Queda PROHIBIDO compartir, redistribuir o revender este software.</li>
        <li>No se permite compartir las credenciales de acceso con otros docentes.</li>
        <li>No se permite copiar, modificar o crear trabajos derivados.</li>
        <li>No se permite el uso comercial mÃ¡s allÃ¡ de la licencia adquirida.</li>
       </ul>
      </section>
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">5. Privacidad</h3>
       <p>Los datos de los estudiantes son confidenciales y solo se utilizan para el funcionamiento del sistema educativo. No se comparten con terceros.</p>
      </section>
      <section>
       <h3 class="text-pink-400 font-bold text-lg mb-2">6. Contacto</h3>
       <p>Para adquirir una licencia o resolver dudas, contacte a la Maestra MarÃ­a Fernanda Flores Valenzuela.</p>
      </section>
      <div class="bg-yellow-500/20 p-4 rounded-xl mt-4">
       <p class="text-yellow-300 font-bold text-center">âš ï¸ El uso no autorizado de este software constituye una violaciÃ³n de derechos de autor y puede resultar en acciones legales.</p>
      </div>
     </div><button onclick="closeTerms()" class="w-full mt-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl text-white font-bold hover:scale-105 transition-transform"> Entendido </button>
    </div>
   </div><!-- Game Complete Modal -->
   <div id="gameCompleteModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-green-700 to-cyan-700 rounded-3xl p-8 max-w-sm w-full text-center neon-green bounce-in">
     <div class="text-7xl mb-4">
      ğŸ†
     </div>
     <h2 class="text-3xl font-black text-white mb-2">Â¡JUEGO COMPLETADO!</h2>
     <div id="gameResults" class="text-xl text-green-200 mb-4 space-y-2"></div>
     <div id="gameRewards" class="bg-black/30 rounded-xl p-4 mb-4">
      <p class="text-yellow-300 font-bold text-lg">Recompensas ganadas:</p>
      <div id="rewardsList" class="text-white font-semibold"></div>
     </div><button onclick="closeGameComplete()" class="bg-gradient-to-r from-yellow-400 to-orange-500 px-8 py-3 rounded-2xl text-white font-black text-xl hover:scale-105 transition-transform"> Â¡CONTINUAR! </button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: 'Material SEP Interactivo',
      welcome_message: 'Â¡Aprende y gana estrellas!'
    };
    
    let currentUser = null;
    let allUsers = [];
    let gameTimer = null;
    let currentGame = null;
    let gameState = {
      correct: 0,
      wrong: 0,
      timeLeft: 60,
      questions: [],
      currentQuestion: 0
    };

    const dailyTasksTemplate = [
      { id: 'alphabet', name: 'Resuelve el juego de AlfabetizaciÃ³n', icon: 'ğŸ“š', subject: 'espaÃ±ol' },
      { id: 'math', name: 'Completa un juego de MatemÃ¡ticas', icon: 'ğŸ”¢', subject: 'matematicas' },
      { id: 'english_perfect', name: 'Juega InglÃ©s sin fallar', icon: 'ğŸ‡¬ğŸ‡§', subject: 'ingles', requirePerfect: true },
      { id: 'science', name: 'Juega Ciencias Naturales', icon: 'ğŸ”¬', subject: 'ciencias' },
      { id: 'any_game', name: 'Juega cualquier juego', icon: 'ğŸ®', subject: 'any' }
    ];

    const weeklyTasksTemplate = [
      { id: 'play_5', name: 'Juega 5 partidas', icon: 'ğŸ¯', target: 5, type: 'games' },
      { id: 'all_subjects', name: 'Juega todas las materias', icon: 'ğŸ“–', type: 'subjects' },
      { id: 'streak_3', name: 'MantÃ©n racha de 3 dÃ­as', icon: 'ğŸ”¥', target: 3, type: 'streak' }
    ];

    const games = [
      { id: 'espaÃ±ol', name: 'EspaÃ±ol', icon: 'ğŸ“š', color: 'from-pink-500 to-red-500', subject: 'espaÃ±ol' },
      { id: 'matematicas', name: 'MatemÃ¡ticas', icon: 'ğŸ”¢', color: 'from-blue-500 to-cyan-500', subject: 'matematicas' },
      { id: 'ciencias', name: 'Ciencias', icon: 'ğŸ”¬', color: 'from-green-500 to-emerald-500', subject: 'ciencias' },
      { id: 'historia', name: 'Historia', icon: 'ğŸ›ï¸', color: 'from-amber-500 to-orange-500', subject: 'historia' },
      { id: 'geografia', name: 'GeografÃ­a', icon: 'ğŸŒ', color: 'from-teal-500 to-cyan-500', subject: 'geografia' },
      { id: 'socioemocional', name: 'Socioemocional', icon: 'ğŸ’–', color: 'from-purple-500 to-pink-500', subject: 'socioemocional' },
      { id: 'ingles', name: 'InglÃ©s', icon: 'ğŸ‡¬ğŸ‡§', color: 'from-red-500 to-blue-500', subject: 'ingles' }
    ];

    const questionsDB = {
      espaÃ±ol: [
        { q: 'Â¿CuÃ¡l es el plural de "lÃ¡piz"?', options: ['LÃ¡pizes', 'LÃ¡pices', 'Lapizes', 'Lapices'], correct: 1 },
        { q: 'Â¿QuÃ© tipo de palabra es "rÃ¡pidamente"?', options: ['Sustantivo', 'Adjetivo', 'Adverbio', 'Verbo'], correct: 2 },
        { q: 'Â¿CuÃ¡l es el sinÃ³nimo de "feliz"?', options: ['Triste', 'Contento', 'Enojado', 'Cansado'], correct: 1 },
        { q: 'Â¿QuÃ© signo va al final de una pregunta?', options: ['.', '!', '?', ','], correct: 2 },
        { q: 'Ordena alfabÃ©ticamente: Ã¡rbol, agua, azul', options: ['Ã¡rbol, agua, azul', 'agua, Ã¡rbol, azul', 'azul, agua, Ã¡rbol', 'agua, azul, Ã¡rbol'], correct: 3 },
        { q: 'Â¿CuÃ¡l palabra estÃ¡ bien escrita?', options: ['Haber', 'Haver', 'Aber', 'Aver'], correct: 0 },
        { q: 'Â¿QuÃ© es un sustantivo?', options: ['Una acciÃ³n', 'Un nombre', 'Una cualidad', 'Una cantidad'], correct: 1 },
        { q: 'El antÃ³nimo de "grande" es:', options: ['Enorme', 'PequeÃ±o', 'Alto', 'Ancho'], correct: 1 }
      ],
      matematicas: [
        { q: 'Â¿CuÃ¡nto es 25 + 37?', options: ['52', '62', '72', '82'], correct: 1 },
        { q: 'Â¿CuÃ¡nto es 8 Ã— 7?', options: ['54', '56', '58', '48'], correct: 1 },
        { q: 'Â¿CuÃ¡nto es 100 - 45?', options: ['45', '55', '65', '75'], correct: 1 },
        { q: 'Â¿CuÃ¡l es el doble de 24?', options: ['46', '48', '50', '52'], correct: 1 },
        { q: 'Â¿CuÃ¡ntos lados tiene un hexÃ¡gono?', options: ['4', '5', '6', '8'], correct: 2 },
        { q: 'Â¿CuÃ¡nto es 144 Ã· 12?', options: ['10', '11', '12', '13'], correct: 2 },
        { q: 'Â¿QuÃ© nÃºmero sigue: 2, 4, 8, 16, ...?', options: ['18', '24', '32', '20'], correct: 2 },
        { q: 'Â¿CuÃ¡nto es 3/4 de 20?', options: ['10', '12', '15', '18'], correct: 2 }
      ],
      ciencias: [
        { q: 'Â¿QuÃ© planeta es el mÃ¡s cercano al Sol?', options: ['Venus', 'Tierra', 'Mercurio', 'Marte'], correct: 2 },
        { q: 'Â¿QuÃ© Ã³rgano bombea la sangre?', options: ['PulmÃ³n', 'HÃ­gado', 'CorazÃ³n', 'RiÃ±Ã³n'], correct: 2 },
        { q: 'Â¿Las plantas producen oxÃ­geno mediante...?', options: ['RespiraciÃ³n', 'FotosÃ­ntesis', 'DigestiÃ³n', 'EvaporaciÃ³n'], correct: 1 },
        { q: 'Â¿CuÃ¡ntos huesos tiene el cuerpo humano adulto?', options: ['106', '156', '206', '256'], correct: 2 },
        { q: 'Â¿QuÃ© tipo de animal es la ballena?', options: ['Pez', 'MamÃ­fero', 'Reptil', 'Anfibio'], correct: 1 },
        { q: 'Â¿CuÃ¡l es el estado del agua cuando hierve?', options: ['SÃ³lido', 'LÃ­quido', 'Gaseoso', 'Plasma'], correct: 2 },
        { q: 'Â¿QuÃ© vitamina nos da el Sol?', options: ['A', 'B', 'C', 'D'], correct: 3 },
        { q: 'Â¿Los insectos tienen cuÃ¡ntas patas?', options: ['4', '6', '8', '10'], correct: 1 }
      ],
      historia: [
        { q: 'Â¿QuiÃ©n fue el primer presidente de MÃ©xico?', options: ['Benito JuÃ¡rez', 'Guadalupe Victoria', 'Porfirio DÃ­az', 'Miguel Hidalgo'], correct: 1 },
        { q: 'Â¿En quÃ© aÃ±o iniciÃ³ la Independencia de MÃ©xico?', options: ['1800', '1810', '1821', '1910'], correct: 1 },
        { q: 'Â¿QuiÃ©n dio el Grito de Dolores?', options: ['JosÃ© MarÃ­a Morelos', 'Miguel Hidalgo', 'Ignacio Allende', 'Vicente Guerrero'], correct: 1 },
        { q: 'Â¿QuÃ© civilizaciÃ³n construyÃ³ TeotihuacÃ¡n?', options: ['Mayas', 'Aztecas', 'Teotihuacanos', 'Olmecas'], correct: 2 },
        { q: 'Â¿En quÃ© aÃ±o llegÃ³ CristÃ³bal ColÃ³n a AmÃ©rica?', options: ['1492', '1500', '1521', '1810'], correct: 0 },
        { q: 'Â¿QuiÃ©n conquistÃ³ el Imperio Azteca?', options: ['Francisco Pizarro', 'HernÃ¡n CortÃ©s', 'Pedro de Alvarado', 'CristÃ³bal ColÃ³n'], correct: 1 },
        { q: 'Â¿QuÃ© celebramos el 5 de mayo?', options: ['Independencia', 'RevoluciÃ³n', 'Batalla de Puebla', 'ConstituciÃ³n'], correct: 2 },
        { q: 'Â¿QuiÃ©n fue conocido como el "BenemÃ©rito de las AmÃ©ricas"?', options: ['Hidalgo', 'JuÃ¡rez', 'Morelos', 'Madero'], correct: 1 }
      ],
      geografia: [
        { q: 'Â¿CuÃ¡l es la capital de MÃ©xico?', options: ['Guadalajara', 'Monterrey', 'Ciudad de MÃ©xico', 'Puebla'], correct: 2 },
        { q: 'Â¿CuÃ¡ntos estados tiene MÃ©xico?', options: ['30', '31', '32', '33'], correct: 2 },
        { q: 'Â¿QuÃ© ocÃ©ano estÃ¡ al oeste de MÃ©xico?', options: ['AtlÃ¡ntico', 'PacÃ­fico', 'Ãndico', 'Ãrtico'], correct: 1 },
        { q: 'Â¿CuÃ¡l es el rÃ­o mÃ¡s largo de MÃ©xico?', options: ['Lerma', 'Bravo', 'Grijalva', 'Usumacinta'], correct: 1 },
        { q: 'Â¿Con quÃ© paÃ­s limita MÃ©xico al norte?', options: ['Guatemala', 'Belice', 'Estados Unidos', 'Honduras'], correct: 2 },
        { q: 'Â¿CuÃ¡l es el volcÃ¡n mÃ¡s alto de MÃ©xico?', options: ['PopocatÃ©petl', 'IztaccÃ­huatl', 'Pico de Orizaba', 'Nevado de Toluca'], correct: 2 },
        { q: 'Â¿QuÃ© penÃ­nsula estÃ¡ al sureste de MÃ©xico?', options: ['Baja California', 'YucatÃ¡n', 'Alaska', 'Florida'], correct: 1 },
        { q: 'Â¿CuÃ¡l es el estado mÃ¡s grande de MÃ©xico?', options: ['Sonora', 'Chihuahua', 'Coahuila', 'Durango'], correct: 1 }
      ],
      socioemocional: [
        { q: 'Â¿QuÃ© es la empatÃ­a?', options: ['Sentir enojo', 'Entender los sentimientos de otros', 'Estar solo', 'No escuchar'], correct: 1 },
        { q: 'Cuando estÃ¡s enojado, Â¿quÃ© debes hacer?', options: ['Gritar', 'Golpear', 'Respirar y calmarte', 'Correr'], correct: 2 },
        { q: 'Â¿QuÃ© significa ser amable?', options: ['Ignorar a otros', 'Ser grosero', 'Tratar bien a los demÃ¡s', 'No compartir'], correct: 2 },
        { q: 'Â¿CÃ³mo puedes ayudar a un amigo triste?', options: ['Burlarte', 'Ignorarlo', 'Escucharlo', 'Dejarlo solo'], correct: 2 },
        { q: 'Â¿QuÃ© es el respeto?', options: ['Burlarse de otros', 'Tratar bien a todos', 'Gritar', 'Mentir'], correct: 1 },
        { q: 'Si cometes un error, debes:', options: ['Mentir', 'Culpar a otro', 'Aceptarlo y aprender', 'Esconderlo'], correct: 2 },
        { q: 'Â¿QuÃ© emociÃ³n sientes cuando ganas?', options: ['Tristeza', 'AlegrÃ­a', 'Enojo', 'Miedo'], correct: 1 },
        { q: 'Trabajar en equipo significa:', options: ['Hacer todo solo', 'Cooperar con otros', 'No ayudar', 'Competir'], correct: 1 }
      ],
      ingles: [
        { q: 'How do you say "perro" in English?', options: ['Cat', 'Dog', 'Bird', 'Fish'], correct: 1 },
        { q: 'What color is the sky?', options: ['Red', 'Green', 'Blue', 'Yellow'], correct: 2 },
        { q: 'How many days are in a week?', options: ['Five', 'Six', 'Seven', 'Eight'], correct: 2 },
        { q: 'What is "manzana" in English?', options: ['Orange', 'Banana', 'Apple', 'Grape'], correct: 2 },
        { q: 'Complete: "I ___ a student."', options: ['is', 'am', 'are', 'be'], correct: 1 },
        { q: 'What is the opposite of "big"?', options: ['Large', 'Small', 'Tall', 'Wide'], correct: 1 },
        { q: 'How do you say "gracias" in English?', options: ['Please', 'Sorry', 'Thank you', 'Hello'], correct: 2 },
        { q: 'What animal says "meow"?', options: ['Dog', 'Cat', 'Bird', 'Cow'], correct: 1 }
      ]
    };

    const dataHandler = {
      onDataChanged(data) {
        allUsers = data;
        if (currentUser) {
          const updated = data.find(u => u.__backendId === currentUser.__backendId);
          if (updated) {
            currentUser = updated;
            updateUI();
          }
        }
      }
    };

    async function initApp() {
      try {
        await window.dataSdk.init(dataHandler);
      } catch (e) {
        console.error('Data SDK init error:', e);
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const title = document.getElementById('appTitle');
            const welcome = document.getElementById('welcomeMsg');
            if (title) title.textContent = config.app_title || defaultConfig.app_title;
            if (welcome) welcome.textContent = config.welcome_message || defaultConfig.welcome_message;
          },
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      renderGamesGrid();
    }

    function showLogin() {
      document.getElementById('registerScreen').classList.add('hidden');
      document.getElementById('registerScreen').classList.remove('flex');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginScreen').classList.add('flex');
    }

    function showRegister() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('flex');
      document.getElementById('registerScreen').classList.remove('hidden');
      document.getElementById('registerScreen').classList.add('flex');
    }

    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      if (!username || !password) {
        errorEl.textContent = 'Â¡Completa todos los campos!';
        errorEl.classList.remove('hidden');
        return;
      }

      const user = allUsers.find(u => u.username === username && u.password === password);
      if (!user) {
        errorEl.textContent = 'Usuario o contraseÃ±a incorrectos';
        errorEl.classList.remove('hidden');
        return;
      }

      currentUser = user;
      errorEl.classList.add('hidden');
      
      // Check daily login
      await checkDailyLogin();
      
      showDashboard();
    }

    async function handleRegister() {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const grade = document.getElementById('regGrade').value;
      const errorEl = document.getElementById('regError');
      
      if (!username || password.length < 4 || !grade) {
        errorEl.textContent = 'Completa todos los campos';
        errorEl.classList.remove('hidden');
        return;
      }

      if (allUsers.length >= 999) {
        errorEl.textContent = 'LÃ­mite de usuarios alcanzado';
        errorEl.classList.remove('hidden');
        return;
      }

      const exists = allUsers.find(u => u.username === username);
      if (exists) {
        errorEl.textContent = 'Este usuario ya existe';
        errorEl.classList.remove('hidden');
        return;
      }

      const newUser = {
        id: Date.now().toString(),
        username,
        password,
        grade,
        stars: 10,
        coins: 20,
        keys: 3,
        xp: 0,
        level: 1,
        lives: 5,
        dailyStreak: 0,
        lastLoginDate: '',
        dailyTasksCompleted: '[]',
        weeklyTasksCompleted: '[]',
        gamesPlayed: 0,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(newUser);
      if (result.isOk) {
        showReward('ğŸ‰', 'Â¡Cuenta creada!', 'Ganaste: 10â­ + 20ğŸª™ + 3ğŸ”‘');
        showLogin();
      } else {
        errorEl.textContent = 'Error al crear cuenta';
        errorEl.classList.remove('hidden');
      }
    }

    function handleLogout() {
      currentUser = null;
      document.getElementById('mainDashboard').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginScreen').classList.add('flex');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Daily Login Check
    async function checkDailyLogin() {
      const today = new Date().toDateString();
      const lastLogin = currentUser.lastLoginDate;
      
      if (lastLogin !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        let newStreak = 1;
        let streakBonus = false;
        
        if (lastLogin === yesterday.toDateString()) {
          newStreak = (currentUser.dailyStreak || 0) + 1;
        }
        
        // Day 7 mega reward
        let starsReward = 5;
        let coinsReward = 5;
        
        if (newStreak % 7 === 0) {
          starsReward = 50;
          coinsReward = 30;
          streakBonus = true;
        }

        currentUser.dailyStreak = newStreak;
        currentUser.lastLoginDate = today;
        currentUser.stars = (currentUser.stars || 0) + starsReward;
        currentUser.coins = (currentUser.coins || 0) + coinsReward;
        currentUser.dailyTasksCompleted = '[]';
        
        await window.dataSdk.update(currentUser);
        
        if (streakBonus) {
          showReward('ğŸ', 'Â¡DÃA 7 - MEGA RECOMPENSA!', `+${starsReward}â­ +${coinsReward}ğŸª™`);
        } else {
          showReward('ğŸŒŸ', `Â¡DÃ­a ${newStreak} de racha!`, `+${starsReward}â­ +${coinsReward}ğŸª™`);
        }
      }
    }

    // UI Functions
    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('flex');
      document.getElementById('registerScreen').classList.add('hidden');
      document.getElementById('mainDashboard').classList.remove('hidden');
      document.getElementById('mainDashboard').classList.add('flex');
      updateUI();
    }

    function updateUI() {
      if (!currentUser) return;
      
      document.getElementById('playerName').textContent = currentUser.username;
      document.getElementById('playerGrade').textContent = `(${currentUser.grade})`;
      document.getElementById('starsDisplay').textContent = currentUser.stars || 0;
      document.getElementById('coinsDisplay').textContent = currentUser.coins || 0;
      document.getElementById('keysDisplay').textContent = currentUser.keys || 0;
      document.getElementById('livesDisplay').textContent = currentUser.lives || 0;
      
      const level = currentUser.level || 1;
      const xp = currentUser.xp || 0;
      const xpNeeded = level * 100;
      const xpPercent = Math.min((xp / xpNeeded) * 100, 100);
      
      document.getElementById('levelDisplay').textContent = level;
      document.getElementById('levelText').textContent = level;
      document.getElementById('xpCurrent').textContent = xp;
      document.getElementById('xpNeeded').textContent = xpNeeded;
      document.getElementById('xpBar').style.width = xpPercent + '%';
      
      // Streak
      const streak = currentUser.dailyStreak || 0;
      document.getElementById('streakDisplay').textContent = streak;
      
      const streakDots = document.getElementById('streakDots');
      streakDots.innerHTML = '';
      for (let i = 1; i <= 7; i++) {
        const dot = document.createElement('div');
        dot.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${
          i <= (streak % 7 || (streak > 0 && streak % 7 === 0 ? 7 : 0)) 
            ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white' 
            : 'bg-slate-600 text-slate-400'
        }`;
        dot.textContent = i;
        streakDots.appendChild(dot);
      }
      
      if (streak >= 6 && streak % 7 !== 0) {
        document.getElementById('day7Reward').classList.remove('hidden');
      } else {
        document.getElementById('day7Reward').classList.add('hidden');
      }
      
      renderDailyTasks();
      renderWeeklyTasks();
    }

    function renderDailyTasks() {
      const container = document.getElementById('dailyTasksList');
      const completed = JSON.parse(currentUser.dailyTasksCompleted || '[]');
      
      container.innerHTML = '';
      let completedCount = 0;
      
      dailyTasksTemplate.forEach(task => {
        const isDone = completed.includes(task.id);
        if (isDone) completedCount++;
        
        const div = document.createElement('div');
        div.className = `flex items-center gap-3 p-3 rounded-xl ${isDone ? 'bg-green-500/20' : 'bg-slate-700/50'}`;
        div.innerHTML = `
          <span class="text-2xl">${isDone ? 'âœ…' : task.icon}</span>
          <span class="flex-1 font-semibold ${isDone ? 'text-green-300 line-through' : 'text-white'}">${task.name}</span>
          <span class="text-yellow-300 font-bold">+5â­</span>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('tasksCompleted').textContent = completedCount;
      
      if (completedCount >= 5) {
        document.getElementById('allTasksBonus').classList.remove('hidden');
      } else {
        document.getElementById('allTasksBonus').classList.add('hidden');
      }
    }

    function renderWeeklyTasks() {
      const container = document.getElementById('weeklyTasksList');
      const weeklyCompleted = JSON.parse(currentUser.weeklyTasksCompleted || '[]');
      
      container.innerHTML = '';
      
      weeklyTasksTemplate.forEach(task => {
        const isDone = weeklyCompleted.includes(task.id);
        let progress = '';
        
        if (task.type === 'games') {
          progress = `${Math.min(currentUser.gamesPlayed || 0, task.target)}/${task.target}`;
        } else if (task.type === 'streak') {
          progress = `${Math.min(currentUser.dailyStreak || 0, task.target)}/${task.target}`;
        }
        
        const div = document.createElement('div');
        div.className = `flex items-center gap-3 p-3 rounded-xl ${isDone ? 'bg-pink-500/20' : 'bg-slate-700/50'}`;
        div.innerHTML = `
          <span class="text-2xl">${isDone ? 'ğŸ†' : task.icon}</span>
          <div class="flex-1">
            <span class="font-semibold ${isDone ? 'text-pink-300' : 'text-white'}">${task.name}</span>
            ${progress ? `<span class="text-sm text-purple-300 ml-2">(${progress})</span>` : ''}
          </div>
          <span class="text-yellow-300 font-bold">+20â­</span>
        `;
        container.appendChild(div);
      });
    }

    function renderGamesGrid() {
      const container = document.getElementById('gamesGrid');
      container.innerHTML = '';
      
      games.forEach(game => {
        const card = document.createElement('div');
        card.className = `game-card bg-gradient-to-br ${game.color} rounded-2xl p-4 cursor-pointer neon-box`;
        card.onclick = () => startGame(game);
        card.innerHTML = `
          <div class="text-4xl text-center mb-2 floating">${game.icon}</div>
          <p class="text-white font-bold text-center text-sm">${game.name}</p>
        `;
        container.appendChild(card);
      });
    }

    // Game Functions
    function startGame(game) {
      if (currentUser.lives <= 0) {
        showReward('ğŸ’”', 'Â¡Sin vidas!', 'Compra vidas en la tienda');
        return;
      }
      
      currentGame = game;
      gameState = {
        correct: 0,
        wrong: 0,
        timeLeft: 60,
        questions: [],
        currentQuestion: 0,
        perfectRun: true
      };
      
      document.getElementById('mainDashboard').classList.add('hidden');
      document.getElementById('mainDashboard').classList.remove('flex');
      document.getElementById('gameScreen').classList.remove('hidden');
      document.getElementById('gameScreen').classList.add('flex');
      
      document.getElementById('gameTitle').textContent = `${game.icon} ${game.name}`;
      document.getElementById('gameLives').textContent = currentUser.lives;
      document.getElementById('correctCount').textContent = 0;
      document.getElementById('wrongCount').textContent = 0;
      
      // Show subject menu instead of starting immediately
      showSubjectMenu(game);
    }

    function showSubjectMenu(game) {
      const container = document.getElementById('gameContent');
      container.innerHTML = `
        <div class="text-center space-y-4">
          <p class="text-xl text-purple-300 font-bold mb-6">Â¿CuÃ¡ntas preguntas deseas?</p>
          <button onclick="startGameQuestions(${5}, '${game.subject}')" class="w-full py-4 px-6 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-xl text-white font-black text-xl hover:scale-105 transition-transform">
            âš¡ 5 preguntas (RÃ¡pido)
          </button>
          <button onclick="startGameQuestions(${10}, '${game.subject}')" class="w-full py-4 px-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl text-white font-black text-xl hover:scale-105 transition-transform">
            ğŸ¯ 10 preguntas (Normal)
          </button>
          <button onclick="startGameQuestions(${15}, '${game.subject}')" class="w-full py-4 px-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl text-white font-black text-xl hover:scale-105 transition-transform">
            ğŸ”¥ 15 preguntas (DesafÃ­o)
          </button>
          <button onclick="exitGame()" class="w-full py-4 px-6 bg-slate-600 rounded-xl text-white font-bold text-lg hover:bg-slate-500 transition-colors mt-6">
            â† Volver
          </button>
        </div>
      `;
    }

    function startGameQuestions(count, subject) {
      gameState.questions = shuffleArray([...questionsDB[subject]]).slice(0, count);
      gameState.currentQuestion = 0;
      showQuestion();
      startTimer();
    }

    function showQuestion() {
      if (gameState.currentQuestion >= gameState.questions.length) {
        endGame();
        return;
      }
      
      const q = gameState.questions[gameState.currentQuestion];
      const container = document.getElementById('gameContent');
      
      container.innerHTML = `
        <p class="text-sm text-purple-300 mb-2">Pregunta ${gameState.currentQuestion + 1}/${gameState.questions.length}</p>
        <h3 class="text-xl font-bold text-white mb-6">${q.q}</h3>
        <div class="grid grid-cols-1 gap-3" id="optionsContainer"></div>
      `;
      
      const optContainer = document.getElementById('optionsContainer');
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'w-full py-4 px-6 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold text-lg transition-all hover:scale-102';
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(idx);
        optContainer.appendChild(btn);
      });
    }

    async function checkAnswer(selected) {
      const q = gameState.questions[gameState.currentQuestion];
      const buttons = document.getElementById('optionsContainer').children;
      
      // Disable all buttons
      Array.from(buttons).forEach(btn => btn.disabled = true);
      
      if (selected === q.correct) {
        buttons[selected].classList.add('bg-green-500', 'scale-105');
        gameState.correct++;
        document.getElementById('correctCount').textContent = gameState.correct;
        createConfetti();
      } else {
        buttons[selected].classList.add('bg-red-500', 'shake');
        buttons[q.correct].classList.add('bg-green-500');
        gameState.wrong++;
        gameState.perfectRun = false;
        document.getElementById('wrongCount').textContent = gameState.wrong;
        
        // Lose a life
        currentUser.lives = Math.max(0, (currentUser.lives || 0) - 1);
        document.getElementById('gameLives').textContent = currentUser.lives;
        await window.dataSdk.update(currentUser);
      }
      
      setTimeout(() => {
        gameState.currentQuestion++;
        showQuestion();
      }, 1000);
    }

    function startTimer() {
      clearInterval(gameTimer);
      const timerEl = document.getElementById('gameTimer');
      
      gameTimer = setInterval(() => {
        gameState.timeLeft--;
        timerEl.textContent = `â±ï¸ ${gameState.timeLeft}`;
        
        if (gameState.timeLeft <= 10) {
          timerEl.classList.add('timer-urgent');
        }
        
        if (gameState.timeLeft <= 0) {
          endGame();
        }
      }, 1000);
    }

    async function endGame() {
      clearInterval(gameTimer);
      
      const starsEarned = gameState.correct * 3;
      const coinsEarned = gameState.correct * 2;
      const xpEarned = gameState.correct * 10;
      
      currentUser.stars = (currentUser.stars || 0) + starsEarned;
      currentUser.coins = (currentUser.coins || 0) + coinsEarned;
      currentUser.xp = (currentUser.xp || 0) + xpEarned;
      currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
      
      // Check level up
      const xpNeeded = (currentUser.level || 1) * 100;
      if (currentUser.xp >= xpNeeded) {
        currentUser.level = (currentUser.level || 1) + 1;
        currentUser.xp = currentUser.xp - xpNeeded;
        currentUser.keys = (currentUser.keys || 0) + 1;
      }
      
      // Update daily tasks
      let dailyCompleted = JSON.parse(currentUser.dailyTasksCompleted || '[]');
      const subject = currentGame.subject;
      
      // Check various tasks
      if (subject === 'espaÃ±ol' && !dailyCompleted.includes('alphabet')) {
        dailyCompleted.push('alphabet');
        currentUser.stars += 5;
      }
      if (subject === 'matematicas' && !dailyCompleted.includes('math')) {
        dailyCompleted.push('math');
        currentUser.stars += 5;
      }
      if (subject === 'ciencias' && !dailyCompleted.includes('science')) {
        dailyCompleted.push('science');
        currentUser.stars += 5;
      }
      if (subject === 'ingles' && gameState.perfectRun && !dailyCompleted.includes('english_perfect')) {
        dailyCompleted.push('english_perfect');
        currentUser.stars += 5;
      }
      if (!dailyCompleted.includes('any_game')) {
        dailyCompleted.push('any_game');
        currentUser.stars += 5;
      }
      
      // Bonus for completing all 5
      if (dailyCompleted.length >= 5) {
        const hadBonus = JSON.parse(currentUser.dailyTasksCompleted || '[]').length >= 5;
        if (!hadBonus) {
          currentUser.stars += 50;
          currentUser.coins += 20;
        }
      }
      
      currentUser.dailyTasksCompleted = JSON.stringify(dailyCompleted);
      
      // Weekly tasks check
      let weeklyCompleted = JSON.parse(currentUser.weeklyTasksCompleted || '[]');
      if (currentUser.gamesPlayed >= 5 && !weeklyCompleted.includes('play_5')) {
        weeklyCompleted.push('play_5');
        currentUser.stars += 20;
      }
      if (currentUser.dailyStreak >= 3 && !weeklyCompleted.includes('streak_3')) {
        weeklyCompleted.push('streak_3');
        currentUser.stars += 20;
      }
      currentUser.weeklyTasksCompleted = JSON.stringify(weeklyCompleted);
      
      await window.dataSdk.update(currentUser);
      
      // Show results
      document.getElementById('gameResults').innerHTML = `
        <p>âœ… Correctas: <span class="text-green-400 font-black">${gameState.correct}</span></p>
        <p>âŒ Errores: <span class="text-red-400 font-black">${gameState.wrong}</span></p>
        ${gameState.perfectRun ? '<p class="text-yellow-300 font-bold">ğŸŒŸ Â¡PERFECTO!</p>' : ''}
      `;
      
      document.getElementById('rewardsList').innerHTML = `
        <p>â­ +${starsEarned} estrellas</p>
        <p>ğŸª™ +${coinsEarned} monedas</p>
        <p>âš¡ +${xpEarned} XP</p>
      `;
      
      document.getElementById('gameCompleteModal').classList.remove('hidden');
      document.getElementById('gameCompleteModal').classList.add('flex');
    }

    function exitGame() {
      clearInterval(gameTimer);
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('flex');
      document.getElementById('mainDashboard').classList.remove('hidden');
      document.getElementById('mainDashboard').classList.add('flex');
      updateUI();
    }

    function closeGameComplete() {
      document.getElementById('gameCompleteModal').classList.add('hidden');
      document.getElementById('gameCompleteModal').classList.remove('flex');
      exitGame();
    }

    // Shop Functions
    function showShop() {
      document.getElementById('shopCoins').textContent = currentUser.coins || 0;
      document.getElementById('shopModal').classList.remove('hidden');
      document.getElementById('shopModal').classList.add('flex');
    }

    function closeShop() {
      document.getElementById('shopModal').classList.add('hidden');
      document.getElementById('shopModal').classList.remove('flex');
    }

    async function buyItem(type, cost) {
      if ((currentUser.coins || 0) < cost) {
        showReward('ğŸ˜¢', 'Â¡No tienes suficientes monedas!', `Necesitas ${cost}ğŸª™`);
        return;
      }
      
      currentUser.coins -= cost;
      
      switch(type) {
        case 'life':
          currentUser.lives = (currentUser.lives || 0) + 1;
          showReward('â¤ï¸', 'Â¡+1 Vida!', 'Sigue jugando');
          break;
        case 'key':
          currentUser.keys = (currentUser.keys || 0) + 1;
          showReward('ğŸ”‘', 'Â¡+1 Llave!', 'Desbloquea juegos');
          break;
        case 'xp':
          currentUser.xp = (currentUser.xp || 0) + 50;
          showReward('âš¡', 'Â¡+50 XP!', 'Sube de nivel');
          break;
        case 'stars':
          currentUser.stars = (currentUser.stars || 0) + 10;
          showReward('â­', 'Â¡+10 Estrellas!', 'Cambia por premios');
          break;
      }
      
      await window.dataSdk.update(currentUser);
      document.getElementById('shopCoins').textContent = currentUser.coins;
      updateUI();
    }

    // Modal Functions
    function showReward(icon, title, text) {
      document.getElementById('rewardIcon').textContent = icon;
      document.getElementById('rewardTitle').textContent = title;
      document.getElementById('rewardText').textContent = text;
      document.getElementById('rewardModal').classList.remove('hidden');
      document.getElementById('rewardModal').classList.add('flex');
    }

    function closeReward() {
      document.getElementById('rewardModal').classList.add('hidden');
      document.getElementById('rewardModal').classList.remove('flex');
    }

    function showTerms() {
      document.getElementById('termsModal').classList.remove('hidden');
      document.getElementById('termsModal').classList.add('flex');
    }

    function closeTerms() {
      document.getElementById('termsModal').classList.add('hidden');
      document.getElementById('termsModal').classList.remove('flex');
    }

    // Utilities
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createConfetti() {
      const colors = ['#fbbf24', '#ec4899', '#06b6d4', '#22c55e', '#8b5cf6'];
      for (let i = 0; i < 20; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.cssText = `
          left: ${Math.random() * 100}%;
          top: ${Math.random() * 50}%;
          width: 10px;
          height: 10px;
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          border-radius: 50%;
          animation: confettiFall 1s ease-out forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 1000);
      }
    }

    // Add confetti animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes confettiFall {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Initialize
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d30748e339eada4',t:'MTc3MTk1MTc1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<script>
  let currentUser = null;
  let allUsers = [];
  let dataReady = false;

  async function initApp() {
    try {
      if (window.dataSdk && typeof window.dataSdk.init === 'function') {
        await window.dataSdk.init(dataHandler);
        dataReady = true;
      } else {
        console.error('Data SDK no disponible');
      }
    } catch (e) {
      console.error('Data SDK init error:', e);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const title = document.getElementById('appTitle');
          const welcome = document.getElementById('welcomeMsg');
          if (title) title.textContent = config.app_title || defaultConfig.app_title;
          if (welcome) welcome.textContent = config.welcome_message || defaultConfig.welcome_message;
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
        ])
      });
    }

    renderGamesGrid();
  }

  async function handleRegister() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const grade = document.getElementById('regGrade').value;
    const errorEl = document.getElementById('regError');

    if (!username || password.length < 4 || !grade) {
      errorEl.textContent = 'Completa todos los campos (contrase√±a m√≠nimo 4)';
      errorEl.classList.remove('hidden');
      return;
    }

    if (!window.dataSdk || typeof window.dataSdk.create !== 'function' || !dataReady) {
      errorEl.textContent = 'El servicio de datos no est√° listo. Recarga la p√°gina e intenta de nuevo.';
      errorEl.classList.remove('hidden');
      return;
    }

    if (allUsers.length >= 999) {
      errorEl.textContent = 'L√≠mite de usuarios alcanzado';
      errorEl.classList.remove('hidden');
      return;
    }

    const exists = findUserByUsername(username);
    if (exists) {
      errorEl.textContent = 'Este usuario ya existe';
      errorEl.classList.remove('hidden');
      return;
    }

    const newUser = {
      id: Date.now().toString(),
      username,
      password,
      grade,
      stars: 10,
      coins: 20,
      keys: 3,
      xp: 0,
      level: 1,
      lives: 5,
      dailyStreak: 0,
      lastLoginDate: '',
      dailyTasksCompleted: '[]',
      weeklyTasksCompleted: '[]',
      subjectsPlayedWeekly: '[]',
      gamesPlayed: 0,
      createdAt: new Date().toISOString()
    };

    try {
      const result = await window.dataSdk.create(newUser);
      const isOk = result?.isOk === true || !!result?.value || !!result?.id;

      if (isOk) {
        const createdUser = result.value || { ...newUser };
        if (!createdUser.__backendId && result.id) {
          createdUser.__backendId = result.id;
        }

        const existingIndex = allUsers.findIndex(
          u => (createdUser.__backendId && u.__backendId === createdUser.__backendId) ||
               normalizeUsername(u.username) === normalizeUsername(createdUser.username)
        );

        if (existingIndex >= 0) {
          allUsers[existingIndex] = createdUser;
        } else {
          allUsers = [...allUsers, createdUser];
        }

        currentUser = createdUser;
        errorEl.classList.add('hidden');
        document.getElementById('regUsername').value = '';
        document.getElementById('regPassword').value = '';

        showReward('üéâ', '¬°Cuenta creada!', 'Ganaste: 10‚≠ê + 20ü™ô + 3üîë');
        await checkDailyLogin();
        showDashboard();
      } else {
        errorEl.textContent = 'Error al crear cuenta';
        errorEl.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Register error:', error);
      errorEl.textContent = 'No se pudo crear la cuenta. Revisa conexi√≥n y vuelve a intentar.';
      errorEl.classList.remove('hidden');
    }
  }
</script>
